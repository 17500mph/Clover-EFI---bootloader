#!/bin/bash

echo "==============================================="
echo "Post-Install RC Scripts"
echo "==============================================="

#echo "DEBUG: $ 1 = Full path to the installation package the installer app is processing: " $1
#echo "DEBUG: $ 2 = Full path to the installation destination: " $2
#echo "DEBUG: $ 3 = Installation volume (mountpoint) to receive the payload: " $3
#echo "DEBUG: $ 4 = Root directory for the system: " $4

echo "preinstall: Path to installer....... $1"
echo "preinstall: Path to destination..... $2"
echo "preinstall: Path to dest volume..... $3"
echo "preinstall: Root of system folder... $4"

#############################################################################

srcvolume="${3}"
destroot="${srcvolume}"
install_log="${srcvolume}/Clover_Install_Log.txt"
installer_plist="${destroot}/EFI/CloverInstaller.plist"
plistbuddy='/usr/libexec/plistbuddy'
installer_on_target_refid='@INSTALLER_ON_TARGET_REFID@'
installer_on_all_volumes_refid='@INSTALLER_ON_ALL_VOLUMES_REFID@'

echo "======================================================" >> "$install_log"
echo "Installing RC Scripts" >> "$install_log"
echo "" >> "$install_log"

# Get the options
install_on_target=$($plistbuddy -c "Print $installer_on_target_refid" \
 "$installer_plist" 2>/dev/null)
install_on_all_volumes=$($plistbuddy -c "Print $installer_on_all_volumes_refid" \
 "$installer_plist" 2>/dev/null)

# Source the rc scripts library
source ./rc_scripts.lib

# Installing the RC scripts on all internal OSX system Volumes
if [[ "$install_on_all_volumes" == true ]]; then
    IFS=$'\n' # ' fix xemacs fontification
    for mountPoint in $(getInternalOSXSystemVolumes); do
        echo "Installing RC scripts in '$mountPoint' volume" >> "$install_log"
        while read -r -u3 file; do
            srcfile=$(echo "${srcvolume}/$file"   | sed -E 's#[/]{2,}#/#g')
            destfile=$(echo "${mountPoint}/$file" | sed -E 's#[/]{2,}#/#g')
            destdir=$(dirname "$destfile")
            if [[ ! -d "$destdir" ]]; then
                mkdir -p "$destdir"
                chown root:wheel "$destdir"
                chmod 755 "$destdir"
            fi
            case "$file" in
                *.d/*.local)
                    if [[ -f "$destfile.disabled" ]]; then
                        rm -f "$destfile"
                        destfile="$destfile.disabled"
                    fi
                    ;;
                *.d/*.local.disabled)
                    enabledfile="${file%.disabled}"
                    rm -f  "$destroot/$enabledfile"
                    ;;
            esac

            # echo "Copying $srcfile to $destfile" >> "$install_log"
            cp -pf "$srcfile" "$destfile"
            chown root:wheel "$destfile"; chmod 755 "$destfile"

        done 3< <(cat ./Tools/rc.files)
    done
fi

# Installing the RC scripts on target volume
[[ "$install_on_target" == true ]] && \
 echo "Installing RC scripts in '$destroot' volume" >> "$install_log"

while read -r -u3 file; do
    srcfile=$(echo "${srcvolume}/$file" | sed -E 's#[/]{2,}#/#g')
    if [[ "$install_on_target" == true ]]; then
        case "$file" in
            *.d/*.local)
                [[ -f "$destroot/$file.disabled" ]] && \
                 mv -f "$srcfile" "$destroot/${file}.disabled"
                ;;
            *.d/*.local.disabled)
                enabledfile="${file%.disabled}"
                rm -fv "$destroot/$enabledfile"
                ;;
        esac
    else
        # Cleanup: remove file and dir
        rm -f "$srcfile"
        rmdir $(dirname "$srcfile") &>/dev/null
    fi
done 3< <(cat ./Tools/rc.files)

# Compatibility with old custom scripts
if [[ "$install_on_target" == true ]]; then
    if [[ -x "${destroot}/etc/custom.rc.local" ]]; then
        echo "Moving ${destroot}/etc/custom.rc.local to ${destroot}/etc/rc.boot.d/50.custom.local" \
         >> "$install_log"
        mv -f "${destroot}/etc/custom.rc.local" "${destroot}/etc/rc.boot.d/50.custom.local"
    fi
    if [[ -x "${destroot}/etc/custom.rc.shutdown.local" ]]; then
        echo "Moving ${destroot}/etc/custom.rc.shutdown.local to ${destroot}/etc/rc.shutdown.d/50.custom.local" \
         >> "$install_log"
        mv -f "${destroot}/etc/custom.rc.shutdown.local" "${destroot}/etc/rc.shutdown.d/50.custom.local"
    fi
fi

echo "" >> "$install_log"
