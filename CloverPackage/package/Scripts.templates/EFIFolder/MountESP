#!/bin/bash

DEST_VOL="$1"
EFI_ROOT_DIR="${2:-${DEST_VOL%*/}/EFIROOTDIR}"

ESPDevice=$(LC_ALL=C diskutil info "$DEST_VOL" 2>/dev/null | \
 sed -n 's/.*Part of Whole: *//p')
if [[ -z "$ESPDevice" ]]; then
    echo "Can't find volume with the name $DEST_VOL"
    exit 1
fi

# Get the name of the ESP device (aka disk3s1)
#ESPDevice=$(echo "$ESPDevice" | sed -E 's@^.*/?(disk[0-9]*).*@\1s1@')
ESPDevice=$(diskutil list "/dev/$ESPDevice"|grep '^\s*\d*\:.*EFI'|grep -o 'disk\d*s\d*')

# Get the ESP mount point if the partition is currently mounted
ESPMountPoint=$(LC_ALL=C diskutil info "$ESPDevice" 2>/dev/null | \
 sed -n 's/.*Mount Point: *//p')

if [[ "$ESPMountPoint" ]]; then
    exitcode=0
else
    ESPMountPoint="/Volumes/ESP"
    exitcode=1

    fstype=$(fstyp /dev/$ESPDevice)
    if [[ -n "$fstype" ]]; then
        [[ ! -d "${ESPMountPoint}" ]] && mkdir -p "${ESPMountPoint}"
        mount -t $fstype /dev/$ESPDevice "${ESPMountPoint}" 2>&1
        exitcode=$?
    fi
fi

if [[ $exitcode -ne 0 ]]; then
    echo
    echo "ERROR: can't mount ESP partition ($ESPDevice) !"
    echo "Check that the partition is well formated in HFS or Fat32."
    echo
    echo "To format as HFS use command like:"
    echo "sudo newfs_hfs -v EFI /dev/r$ESPDevice"
    echo
    echo "For format as Fat32 use command like:"
    echo "sudo newfs_msdos -v EFI -F 32 /dev/r$ESPDevice"
else
    ln -sf "$ESPMountPoint" "$EFI_ROOT_DIR"
fi

exit $exitcode
