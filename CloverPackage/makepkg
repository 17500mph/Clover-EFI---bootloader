#!/bin/bash

# Workspace = edk2/Clover/CloverPackage

# Go to the script directory to create the package
cd "$(dirname $0)"

version=v2
revision=$(cat ../vers.txt)

echo "${version}"  > version
echo "${revision}" > revision

# Workspace = edk2/Clover/CloverPackage

cp -f ../BootHFS/boot1f32-install.sh  CloverV2/EFI/CLOVER/doc/boot1f32-install.sh

# Workspace = edk2/Clover/CloverPackage
# Prepare i386 for building package installer.

if [[ -d "sym/package" && $(stat -f '%u' sym/package) -eq 0 ]]; then
    sudo rm -rf sym
fi
rm -rf sym

# Create a new sym directory
mkdir sym

# Workspace = edk2/Clover/CloverPackage
# Start to build installer.

make pkg
make cdboot
[[ -f "CloverV2/Bootloaders/ia32/boot3" ]] && make cdboot32
make image

(cd sym ; zip Clover_${version}_r${revision}.zip \
 Clover_${version}_r${revision}.pkg              \
 Clover_${version}_r${revision}.pkg.md5 )

# Workspace = edk2/Clover/CloverPackage/
# Remove temp files.

rm -f  version
rm -f  revision

# Workspace = edk2/Clover/CloverPackage
# Open the final folder.
if [ "$1" == "" ]; then
    ls -la sym
    open sym
fi
# Finish building installer.

exit 0
